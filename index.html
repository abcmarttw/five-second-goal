<script>
(() => {
  const TARGET_SEC = 3; // ✅ 成功條件（整數秒 3）

  // ---- 只宣告一次，避免重複宣告錯誤 ----
  const timerEl   = document.getElementById('timer');
  const holdBtn   = document.getElementById('holdBtn');
  const resultEl  = document.getElementById('result');

  const ballTrack = document.getElementById('ballTrack'); // 父層：左右移動
  const ballEl    = document.getElementById('ball');      // 子層：射門
  const goalSvg   = document.querySelector('.goal');

  const goalieEl  = document.getElementById('goalie');    // 守門員
  const flashEl   = document.getElementById('flash');
  const bannerEl  = document.getElementById('banner');
  const qrModal   = document.getElementById('qrModal');
  const closeQr   = document.getElementById('closeQr');
  const goalSound = document.getElementById('goalSound');

  document.addEventListener('contextmenu', e => e.preventDefault(), {passive:false});

  const CFG = { QR_DELAY_MS: 2000, CONFETTI_COUNT: 120, CONFETTI_MIN_DUR: 1.6, CONFETTI_MAX_DUR: 2.8 };

  let startTime = 0;
  let ticker = 0;
  let running = false;
  let kickAnim = null;
  let goalieResetTimer = 0;
  let goalieSpeedTimer = 0; // ⏱️ 隨機加速的 interval id

  const pad2 = n => n.toString().padStart(2,'0');
  const fmtSSCC = ms => { const t=ms/1000,s=Math.floor(t),cs=Math.floor((t-s)*100); return `${pad2(s)}:${pad2(cs)}`; };

  // 射門（動子層，不影響父層左右）
  function kickToGoal(){
    const ball = ballEl.getBoundingClientRect();
    const goal = goalSvg.getBoundingClientRect();
    const dx = (goal.left + goal.width/2) - (ball.left + ball.width/2);
    const dy = (goal.top + goal.height*0.35) - (ball.top + ball.height/2);

    kickAnim = ballEl.animate(
      [
        { transform: 'translate(0,0)' },
        { transform: `translate(${dx*0.6}px, ${dy-140}px)` },
        { transform: `translate(${dx}px, ${dy}px)` }
      ],
      { duration: 850, easing: 'cubic-bezier(.2,.7,.2,1)', fill: 'forwards' }
    );
    return kickAnim.finished.finally(()=>{ kickAnim=null; }).catch(()=>{});
  }

  function wobble(){
    ballEl.animate(
      [
        {transform:'translate(0,0)'},
        {transform:'translate(-18px,-8px) rotate(-6deg)'},
        {transform:'translate(14px,-5px) rotate(6deg)'},
        {transform:'translate(0,0)'}
      ], {duration:420, easing:'ease-in-out'}
    );
  }

  function launchConfetti(){
    const colors = ['#ffd700','#ff6b6b','#4cd964','#5ac8fa','#ff9f0a','#af52de','#ff3b30'];
    for(let i=0;i<CFG.CONFETTI_COUNT;i++){
      const s=document.createElement('div');
      s.className='confetti';
      s.style.left=Math.random()*100+'vw';
      s.style.background=colors[i%colors.length];
      s.style.transform=`translateY(-100px) rotate(${Math.random()*360}deg)`;
      const dur=CFG.CONFETTI_MIN_DUR+Math.random()*(CFG.CONFETTI_MAX_DUR-CFG.CONFETTI_MIN_DUR);
      s.style.animation=`confetti-fall ${dur}s linear forwards`;
      s.style.opacity=0.8+Math.random()*0.2;
      s.style.width=(8+Math.random()*6)+'px';
      s.style.height=(12+Math.random()*10)+'px';
      document.body.appendChild(s);
      setTimeout(()=>s.remove(),dur*1000+400);
    }
  }
  function clearConfetti(){ document.querySelectorAll('.confetti').forEach(e=>e.remove()); }

  function start(){
    if(running) return;
    running = true;
    startTime = performance.now();
    timerEl.textContent = '00:00';
    resultEl.textContent = '';

    // 重置射門動畫與守門員圖
    if (kickAnim){ try{ kickAnim.cancel(); }catch(e){} kickAnim=null; }
    ballEl.getAnimations().forEach(a=>a.cancel());
    ballEl.style.transform = 'translate(0,0)';
    if (goalieResetTimer){ clearTimeout(goalieResetTimer); goalieResetTimer = 0; }
    goalieEl.src = 'goalie.png';

    flashEl.classList.remove('show'); bannerEl.classList.remove('show');
    clearConfetti();

    // 啟動左右移動
    ballTrack.classList.add('running');
    goalieEl.classList.add('running');
    holdBtn.classList.add('hold');
    holdBtn.textContent = '放開射門！';

    // 🧤 隨機加速守門員：每回合重設速度 + 遊戲進行時持續隨機變速
    const firstSpeed = (1.5 + Math.random()*1.5).toFixed(2) + 's';
    goalieEl.style.animationDuration = firstSpeed;
    if (goalieSpeedTimer) clearInterval(goalieSpeedTimer);
    goalieSpeedTimer = setInterval(()=>{
      if (!running) return;
      const newSpeed = (1.5 + Math.random()*1.5).toFixed(2) + 's';
      goalieEl.style.animationDuration = newSpeed;
    }, 1200);

    // 輕量計時
    ticker = setInterval(()=>{ timerEl.textContent = fmtSSCC(performance.now() - startTime); }, 50);
  }

  async function stop(byCancel=false){
    if(!running) return;
    running=false;

    clearInterval(ticker);
    clearInterval(goalieSpeedTimer);
    goalieSpeedTimer = 0;

    const elapsed = (performance.now()-startTime)/1000;
    timerEl.textContent = fmtSSCC(elapsed*1000);

    // 停止左右移動
    ballTrack.classList.remove('running');
    goalieEl.classList.remove('running');
    holdBtn.classList.remove('hold');
    holdBtn.textContent = '按住開始，放開射門';

    const secInt = Math.floor(elapsed);

    if(!byCancel && secInt === TARGET_SEC){
      // 成功：守門員撲空圖、球飛向球門、特效
      goalieEl.src = 'goalie_miss.png';
      await kickToGoal();
      resultEl.innerHTML = 'GOAL!! 三秒命中 🎉<br><span style="display:block;color:#ffeb3b;font-size:clamp(28px,6vw,44px);text-shadow:0 0 14px rgba(255,235,59,.95),0 0 36px rgba(255,235,59,.95);font-weight:900;">挑戰成功！</span>';
      flashEl.classList.add('show'); bannerEl.classList.add('show');
      try{ goalSound.currentTime=0; goalSound.play(); }catch(e){}
      launchConfetti();
      setTimeout(()=> qrModal.classList.add('show'), CFG.QR_DELAY_MS);
    }else{
      // 失敗：守門員接到球圖、球被擋小晃動
      goalieEl.src = 'goalie_save.png';
      resultEl.textContent = (secInt < TARGET_SEC) ? '太早了！被守門員擋下～' : '太晚了！被守門員收下～';
      wobble();
    }

    // 2 秒後把守門員圖恢復
    goalieResetTimer = setTimeout(()=>{ goalieEl.src = 'goalie.png'; }, 2000);
  }

  // 事件（pointer：手機零延遲）
  holdBtn.addEventListener('pointerdown', e=>{ e.preventDefault(); start(); }, {passive:false});
  holdBtn.addEventListener('pointerup',   e=>{ e.preventDefault(); stop(false); }, {passive:false});
  holdBtn.addEventListener('pointercancel', e=>{ e.preventDefault(); stop(true); }, {passive:false});
  holdBtn.addEventListener('pointerleave',  e=>{ if(running){ e.preventDefault(); stop(false); } }, {passive:false});

  // 關閉 QR
  closeQr.addEventListener('pointerdown', ()=> qrModal.classList.remove('show'));
  qrModal.addEventListener('pointerdown', e=>{ if(e.target===qrModal) qrModal.classList.remove('show'); });
})();
</script>
