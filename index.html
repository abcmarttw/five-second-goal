<script>
(() => {
  const TARGET_SEC = 3; // âœ… æˆåŠŸæ¢ä»¶ï¼ˆæ•´æ•¸ç§’ 3ï¼‰

  // ---- åªå®£å‘Šä¸€æ¬¡ï¼Œé¿å…é‡è¤‡å®£å‘ŠéŒ¯èª¤ ----
  const timerEl   = document.getElementById('timer');
  const holdBtn   = document.getElementById('holdBtn');
  const resultEl  = document.getElementById('result');

  const ballTrack = document.getElementById('ballTrack'); // çˆ¶å±¤ï¼šå·¦å³ç§»å‹•
  const ballEl    = document.getElementById('ball');      // å­å±¤ï¼šå°„é–€
  const goalSvg   = document.querySelector('.goal');

  const goalieEl  = document.getElementById('goalie');    // å®ˆé–€å“¡
  const flashEl   = document.getElementById('flash');
  const bannerEl  = document.getElementById('banner');
  const qrModal   = document.getElementById('qrModal');
  const closeQr   = document.getElementById('closeQr');
  const goalSound = document.getElementById('goalSound');

  document.addEventListener('contextmenu', e => e.preventDefault(), {passive:false});

  const CFG = { QR_DELAY_MS: 2000, CONFETTI_COUNT: 120, CONFETTI_MIN_DUR: 1.6, CONFETTI_MAX_DUR: 2.8 };

  let startTime = 0;
  let ticker = 0;
  let running = false;
  let kickAnim = null;
  let goalieResetTimer = 0;
  let goalieSpeedTimer = 0; // â±ï¸ éš¨æ©ŸåŠ é€Ÿçš„ interval id

  const pad2 = n => n.toString().padStart(2,'0');
  const fmtSSCC = ms => { const t=ms/1000,s=Math.floor(t),cs=Math.floor((t-s)*100); return `${pad2(s)}:${pad2(cs)}`; };

  // å°„é–€ï¼ˆå‹•å­å±¤ï¼Œä¸å½±éŸ¿çˆ¶å±¤å·¦å³ï¼‰
  function kickToGoal(){
    const ball = ballEl.getBoundingClientRect();
    const goal = goalSvg.getBoundingClientRect();
    const dx = (goal.left + goal.width/2) - (ball.left + ball.width/2);
    const dy = (goal.top + goal.height*0.35) - (ball.top + ball.height/2);

    kickAnim = ballEl.animate(
      [
        { transform: 'translate(0,0)' },
        { transform: `translate(${dx*0.6}px, ${dy-140}px)` },
        { transform: `translate(${dx}px, ${dy}px)` }
      ],
      { duration: 850, easing: 'cubic-bezier(.2,.7,.2,1)', fill: 'forwards' }
    );
    return kickAnim.finished.finally(()=>{ kickAnim=null; }).catch(()=>{});
  }

  function wobble(){
    ballEl.animate(
      [
        {transform:'translate(0,0)'},
        {transform:'translate(-18px,-8px) rotate(-6deg)'},
        {transform:'translate(14px,-5px) rotate(6deg)'},
        {transform:'translate(0,0)'}
      ], {duration:420, easing:'ease-in-out'}
    );
  }

  function launchConfetti(){
    const colors = ['#ffd700','#ff6b6b','#4cd964','#5ac8fa','#ff9f0a','#af52de','#ff3b30'];
    for(let i=0;i<CFG.CONFETTI_COUNT;i++){
      const s=document.createElement('div');
      s.className='confetti';
      s.style.left=Math.random()*100+'vw';
      s.style.background=colors[i%colors.length];
      s.style.transform=`translateY(-100px) rotate(${Math.random()*360}deg)`;
      const dur=CFG.CONFETTI_MIN_DUR+Math.random()*(CFG.CONFETTI_MAX_DUR-CFG.CONFETTI_MIN_DUR);
      s.style.animation=`confetti-fall ${dur}s linear forwards`;
      s.style.opacity=0.8+Math.random()*0.2;
      s.style.width=(8+Math.random()*6)+'px';
      s.style.height=(12+Math.random()*10)+'px';
      document.body.appendChild(s);
      setTimeout(()=>s.remove(),dur*1000+400);
    }
  }
  function clearConfetti(){ document.querySelectorAll('.confetti').forEach(e=>e.remove()); }

  function start(){
    if(running) return;
    running = true;
    startTime = performance.now();
    timerEl.textContent = '00:00';
    resultEl.textContent = '';

    // é‡ç½®å°„é–€å‹•ç•«èˆ‡å®ˆé–€å“¡åœ–
    if (kickAnim){ try{ kickAnim.cancel(); }catch(e){} kickAnim=null; }
    ballEl.getAnimations().forEach(a=>a.cancel());
    ballEl.style.transform = 'translate(0,0)';
    if (goalieResetTimer){ clearTimeout(goalieResetTimer); goalieResetTimer = 0; }
    goalieEl.src = 'goalie.png';

    flashEl.classList.remove('show'); bannerEl.classList.remove('show');
    clearConfetti();

    // å•Ÿå‹•å·¦å³ç§»å‹•
    ballTrack.classList.add('running');
    goalieEl.classList.add('running');
    holdBtn.classList.add('hold');
    holdBtn.textContent = 'æ”¾é–‹å°„é–€ï¼';

    // ğŸ§¤ éš¨æ©ŸåŠ é€Ÿå®ˆé–€å“¡ï¼šæ¯å›åˆé‡è¨­é€Ÿåº¦ + éŠæˆ²é€²è¡Œæ™‚æŒçºŒéš¨æ©Ÿè®Šé€Ÿ
    const firstSpeed = (1.5 + Math.random()*1.5).toFixed(2) + 's';
    goalieEl.style.animationDuration = firstSpeed;
    if (goalieSpeedTimer) clearInterval(goalieSpeedTimer);
    goalieSpeedTimer = setInterval(()=>{
      if (!running) return;
      const newSpeed = (1.5 + Math.random()*1.5).toFixed(2) + 's';
      goalieEl.style.animationDuration = newSpeed;
    }, 1200);

    // è¼•é‡è¨ˆæ™‚
    ticker = setInterval(()=>{ timerEl.textContent = fmtSSCC(performance.now() - startTime); }, 50);
  }

  async function stop(byCancel=false){
    if(!running) return;
    running=false;

    clearInterval(ticker);
    clearInterval(goalieSpeedTimer);
    goalieSpeedTimer = 0;

    const elapsed = (performance.now()-startTime)/1000;
    timerEl.textContent = fmtSSCC(elapsed*1000);

    // åœæ­¢å·¦å³ç§»å‹•
    ballTrack.classList.remove('running');
    goalieEl.classList.remove('running');
    holdBtn.classList.remove('hold');
    holdBtn.textContent = 'æŒ‰ä½é–‹å§‹ï¼Œæ”¾é–‹å°„é–€';

    const secInt = Math.floor(elapsed);

    if(!byCancel && secInt === TARGET_SEC){
      // æˆåŠŸï¼šå®ˆé–€å“¡æ’²ç©ºåœ–ã€çƒé£›å‘çƒé–€ã€ç‰¹æ•ˆ
      goalieEl.src = 'goalie_miss.png';
      await kickToGoal();
      resultEl.innerHTML = 'GOAL!! ä¸‰ç§’å‘½ä¸­ ğŸ‰<br><span style="display:block;color:#ffeb3b;font-size:clamp(28px,6vw,44px);text-shadow:0 0 14px rgba(255,235,59,.95),0 0 36px rgba(255,235,59,.95);font-weight:900;">æŒ‘æˆ°æˆåŠŸï¼</span>';
      flashEl.classList.add('show'); bannerEl.classList.add('show');
      try{ goalSound.currentTime=0; goalSound.play(); }catch(e){}
      launchConfetti();
      setTimeout(()=> qrModal.classList.add('show'), CFG.QR_DELAY_MS);
    }else{
      // å¤±æ•—ï¼šå®ˆé–€å“¡æ¥åˆ°çƒåœ–ã€çƒè¢«æ“‹å°æ™ƒå‹•
      goalieEl.src = 'goalie_save.png';
      resultEl.textContent = (secInt < TARGET_SEC) ? 'å¤ªæ—©äº†ï¼è¢«å®ˆé–€å“¡æ“‹ä¸‹ï½' : 'å¤ªæ™šäº†ï¼è¢«å®ˆé–€å“¡æ”¶ä¸‹ï½';
      wobble();
    }

    // 2 ç§’å¾ŒæŠŠå®ˆé–€å“¡åœ–æ¢å¾©
    goalieResetTimer = setTimeout(()=>{ goalieEl.src = 'goalie.png'; }, 2000);
  }

  // äº‹ä»¶ï¼ˆpointerï¼šæ‰‹æ©Ÿé›¶å»¶é²ï¼‰
  holdBtn.addEventListener('pointerdown', e=>{ e.preventDefault(); start(); }, {passive:false});
  holdBtn.addEventListener('pointerup',   e=>{ e.preventDefault(); stop(false); }, {passive:false});
  holdBtn.addEventListener('pointercancel', e=>{ e.preventDefault(); stop(true); }, {passive:false});
  holdBtn.addEventListener('pointerleave',  e=>{ if(running){ e.preventDefault(); stop(false); } }, {passive:false});

  // é—œé–‰ QR
  closeQr.addEventListener('pointerdown', ()=> qrModal.classList.remove('show'));
  qrModal.addEventListener('pointerdown', e=>{ if(e.target===qrModal) qrModal.classList.remove('show'); });
})();
</script>
